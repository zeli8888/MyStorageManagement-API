package ze.mystoragemanagement;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import ze.mystoragemanagement.dto.DishIngredientDTO;
import ze.mystoragemanagement.dto.DishRecordIngredientDTO;
import ze.mystoragemanagement.dto.IngredientIdQuantityDTO;
import ze.mystoragemanagement.model.Dish;
import ze.mystoragemanagement.model.DishRecord;
import ze.mystoragemanagement.model.Ingredient;
import ze.mystoragemanagement.repository.DishRepository;
import ze.mystoragemanagement.service.DishRecordService;
import ze.mystoragemanagement.service.DishService;
import ze.mystoragemanagement.service.IngredientService;

import java.time.LocalDateTime;
import java.util.HashSet;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
class MyStorageManagementApplicationTests {

    @Autowired
    private IngredientService ingredientService;
    @Autowired
    private DishService dishService;
    @Autowired
    private DishRepository dishRepository;
    @Autowired
    private DishRecordService dishRecordService;

    @Test
    void contextLoads() {
    }

    @Test
    void deleteIngredient() {
        Ingredient ingredient1 = new Ingredient(null, "test1", 1L, 1L, "test");
        Ingredient ingredient2 = new Ingredient(null, "test2", 1L, 1L, "test");
        Ingredient ingredient3 = new Ingredient(null, "test3", 1L, 1L, "test");
        Ingredient ingredient4 = new Ingredient(null, "test4", 1L, 1L, "test");

        ingredientService.createIngredient(ingredient1);
        ingredientService.createIngredient(ingredient2);
        ingredientService.createIngredient(ingredient3);
        ingredientService.createIngredient(ingredient4);

        Dish dish1 = new Dish(null, "test1", "test1", new HashSet<>());
        Dish dish2 = new Dish(null, "test2", "test2", new HashSet<>());
        Dish dish3 = new Dish(null, "test3", "test3", new HashSet<>());
        Dish dish4 = new Dish(null, "test4", "test4", new HashSet<>());

        dishService.createDish(new DishIngredientDTO(dish1, new IngredientIdQuantityDTO[]{
                new IngredientIdQuantityDTO(1L, 1L), new IngredientIdQuantityDTO(2L, 1L)
        }));

        dishService.createDish(new DishIngredientDTO(dish2, new IngredientIdQuantityDTO[]{
                new IngredientIdQuantityDTO(1L, 1L), new IngredientIdQuantityDTO(3L, 1L)
        }));

        DishRecord dishRecord1 = new DishRecord(null, LocalDateTime.now(), "testRecord1", dish1, new HashSet<>());
        DishRecord dishRecord2 = new DishRecord(null, LocalDateTime.now(), "testRecord2", dish2, new HashSet<>());
        DishRecord dishRecord3 = new DishRecord(null, LocalDateTime.now(), "testRecord3", dish3, new HashSet<>());
        DishRecord dishRecord4 = new DishRecord(null, LocalDateTime.now(), "testRecord4", dish4, new HashSet<>());
        DishRecord dishRecord5 = new DishRecord(null, LocalDateTime.now(), "testRecord5", dish4, new HashSet<>());

        dishRecordService.createDishRecord(new DishRecordIngredientDTO(dishRecord1, new IngredientIdQuantityDTO[]{
                new IngredientIdQuantityDTO(1L, 1L), new IngredientIdQuantityDTO(2L, 1L)
        }));
        dishRecordService.createDishRecord(new DishRecordIngredientDTO(dishRecord2, new IngredientIdQuantityDTO[]{
                new IngredientIdQuantityDTO(1L, 2L), new IngredientIdQuantityDTO(4L, 2L)
        }));

        assertEquals(2, dishRecordService.getDishRecordById(1L).getDishRecordIngredients().size());
        assertEquals(2, dishRecordService.getDishRecordById(2L).getDishRecordIngredients().size());
        ingredientService.deleteIngredient(1L);

        assertNull(ingredientService.getIngredientById(1L));
        assertEquals(1, dishRecordService.getDishRecordById(1L).getDishRecordIngredients().size());
        assertEquals(1, dishRecordService.getDishRecordById(2L).getDishRecordIngredients().size());

        assertEquals(1, dishService.getDishByName("test1").getDishIngredients().size());
        assertEquals(1, dishService.getDishByName("test2").getDishIngredients().size());

        dishRecordService.deleteDishRecord(1L);
        assertNotNull(dishService.getDishById(1L));
    }

}
